<!DOCTYPE html>
<html lang="en">
<head>
    <!-- All previous meta tags and links remain the same -->
    <style>
        /* Updated typing cursor animation */
        @keyframes blink-cursor {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        .typing-cursor {
            animation: blink-cursor 0.8s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="chat-app">
        <!-- All previous HTML structure remains the same -->
        
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Previous code remains the same until photo input handling

                // Fixed photo input handling
                photoInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const file = e.target.files[0];
                        if (file.size > 5 * 1024 * 1024) {
                            addMessage({error: true, message: "Please select an image smaller than 5MB."}, false, true);
                            return;
                        }
                        if (!file.type.startsWith('image/')) {
                            addMessage({error: true, message: "Please select a valid image file."}, false, true);
                            return;
                        }

                        const reader = new FileReader();
                        reader.onload = function(e) {
                            photoPreviewImage.src = e.target.result;
                            photoPreviewContainer.classList.add('visible');
                            currentPhotoData = e.target.result;
                            sendButton.disabled = false;
                            messageInput.disabled = true; // Enable input even with photo
                        };
                        reader.readAsDataURL(file);
                    }
                });

                // Fixed sendMessage function
                function sendMessage(withPhoto = false) {
                    const messageText = messageInput.value.trim();
                    if (!messageText && !withPhoto) return;

                    conversationHistory.push({
                        text: messageText,
                        isUser: true,
                        timestamp: new Date(),
                        photoData: withPhoto ? currentPhotoData : null
                    });

                    const messageContainer = addMessage(
                        messageText, 
                        true, 
                        false, 
                        false, 
                        withPhoto ? [currentPhotoData] : null,
                        true
                    );

                    messageInput.value = '';
                    messageInput.style.height = 'auto';
                    sendButton.disabled = true;
                    charCounter.classList.remove('visible');
                    messageInput.disabled = false; // Re-enable input

                    sendToGemini(messageText, withPhoto ? currentPhotoData : null);

                    if (withPhoto) {
                        currentPhotoData = null;
                        photoPreviewImage.src = '';
                        photoPreviewContainer.classList.remove('visible');
                    }
                }

                // Fixed formatMessagesForAPI to handle images correctly
                function formatMessagesForAPI(messageText, photoData) {
                    const formattedConversation = [];
                    // Base prompt and history remains same

                    if (photoData) {
                        const userParts = [{ text: messageText || "Sent a photo" }]; // Ensure text exists
                        userParts.push({ 
                            inline_data: { 
                                mime_type: "image/jpeg", 
                                data: photoData.split(',')[1] 
                            }
                        });
                        formattedConversation.push({ role: "user", parts: userParts });
                    } else if (messageText) {
                        formattedConversation.push({ role: "user", parts: [{ text: messageText }] });
                    }

                    return formattedConversation;
                }

                // Rest of the JavaScript code remains the same -->
            });
        </script>
    </div>
</body>
</html>